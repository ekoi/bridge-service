# Dataverse Bridge to Digital Archive Repository (DAR)

![Dataverse Bridge](dataverse-bridge.png "Dataverse Bridge")

## Overview

A bridge for Archiving Dataverse dataset to Digital Archive Repository (DAR) via the SWORD v2.0 protocol.\
The application consists of the following parts:
*  bridge-plugin
*  bridge-service
*  bridge-plugin-easy, which is the implentation of bridge-plugin for ingesting data to EASY repository

Due to modularity, maintainability and artifical separation purposes, the Dataverse Bridge application uses a simple plugin system architecture.
Thanks to the [Java reflection API](https://docs.oracle.com/javase/tutorial/reflect/) that allows [runtime type introspections](https://en.wikipedia.org/wiki/Type_introspection),
and [dynamic code loading](https://en.wikipedia.org/wiki/Dynamic_loading), the bridge-service will call plugin (eg: bridge-plugin-easy) without knowing all the details of plugin in advance. More details how to create a new plugin can be found [here](#creating-plugin)

![Plugins System](bridge-service.png "Plugins System")

### Dataverse Configuration

![Archive button](archive-button.png "Archive Button")

To enable "Archive" button on the dataverse side, the following configurations are needed:

__Database Settings__

* :DataverseBridgeConf

Create a json (eg: dvn.json) file that contains the bridge url, the user group which permission to do archiving.
```
{
    "dataverse-bridge-url": "http://localhost:8592/api",
    "user-group": "SWORD",
    "conf":
        [
            {
                "darName": "EASY",
                "dvBaseMetadataXml": "https://test.dataverse.nl/api/datasets/export?exporter=ddi&persistentId="
             }
         ]
 }
```

curl -X PUT -d '/path-to/dvn.json' http://localhost:8080/api/admin/settings/:DataverseBridgeConf

__Role Setting__

Todo:

## bridge-service

The bridge-service of Dataverse Bridge application was generated by the [swagger-codegen](https://github.com/swagger-api/swagger-codegen) project.
It uses [OpenAPI-Spec](https://github.com/swagger-api/swagger-core) to generate the server stub.

The underlying library integrating swagger to SpringBoot is [springfox](https://github.com/springfox/springfox)


###### How to generate:

```
swagger-codegen generate -i dataverse-bridge-api.yaml -l spring -o . -c dataverse-bridge-config.json\
 --import-mappings Archiving=nl.knaw.dans.dataverse.bridge.service.db.domain.ArchivingAuditLog

```

__.swagger-codegen-ignore__

```
pom.xml
src/main/java/nl/knaw/dans/dataverse/bridge/service/*
src/main/resources/application.properties
```

## Start the Bridge Appication

Starting the server as an simple java application

Change default port value in application.properties

```
java -Dspring.profiles.active=dev -jar target/dataverse-bridge-0.5.0.jar

java -Dspring.profiles.active=dev -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5105 -Xms128M -Xmx2G -jar dataverse-bridge-0.1.0.jar

```

You can view the api documentation in swagger-ui by pointing to
http://localhost:8592/api

![Bridge API](bridge-api.png "Bridge API")



**dar-target-conf**

*easy-dev.json*:
```
{
    "dar-name":"EASY",
    "iri":"http://deasy.dans.knaw.nl/sword2/collection/1"
}
```

###### Plugin Directory Structure
You can add the plugin to the plugins directory or you can upload it as zip file.\
The plugin must have the following structure:

```
easy (directory, must be in lowercase)
easy.json (json file that describe the plugin, see an example below)
-- lib (directory where the plugin.jar is located)
-- xsl (directory where the xsl files are located)

```

*easy.json*
```
{
  "dar-name": "EASY",
  "action-class-name": "nl.knaw.dans.dataverse.bridge.plugin.dar.easy.EasyIngestAction",
  "action-class-url": "lib/bridge-plugin-easy-0.5-SNAPSHOT-jar-with-dependencies.jar",
  "xsl":
        [
            {
                "xsl-name":"dataset.xml",
                "xsl-url":"xsl/dvn-ddi2ddm-dataset.xsl"
            },
            {
                "xsl-name":"files.xml",
                "xsl-url":"xsl/dvn-ddi2ddm-files.xsl"
            }
        ]
}
```


__application-dev.properties__

```
################## SPRINGFOX CONFIGURATION ##########################

springfox.documentation.swagger.v2.path=/api-docs
server.address=localhost
server.contextPath=/api
server.port=8592

################### Database Configuration ##########################
spring.datasource.url=jdbc:hsqldb:file:./database/bridgedb;sql.syntax_pgs=true
spring.datasource.username=sa
spring.datasource.password=


################### JavaMail Configuration ##########################
bridge.apps.support.email.from=
bridge.apps.support.email.send.to=eko.indarto@dans.knaw.nl
spring.mail.host=


################# Apps Configuration ##############################
bridge.dar.credentials.checking.timeout=3000
bridge.apikey=this!sMyAP1K3Y10122004
bridge.temp.dir.bags=/path/bagit-temp/bags
bridge.base.path.database.dir=
bridge.base.path.dar.target.conf.dir=
bridge.base.path.plugins.dir=

```

###### <a name="creating-plugin"></a>Creating a plugin